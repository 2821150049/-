# 第12、13讲、复位，时钟，中断

## 一、复位

### 1.系统复位

系统复位将复位除时钟控制寄存器CSR中的复位标志和备份区域中的寄存器以外的所有寄存器为它们的复位数值。

当以下事件中的一件发生时，产生一个系统复位： 

1. NRST引脚上的低电平(外部复位) 
2. 窗口看门狗计数终止(WWDG复位)  
3. 独立看门狗计数终止(IWDG复位)  
4. 软件复位(SW复位)  
5. 低功耗管理复位

**软件复位**

通过将Cortex™-M3中断应用和复位控制寄存器中的SYSRESETREQ位置’1’，可实现软件复 位。请参考Cortex™-M3技术参考手册获得进一步信息。

### 2.电源复位

电源复位将复位除了备份区域外的所有寄存器。

当以下事件中之一发生时，产生电源复位： 

1. 上电/掉电复位(POR/PDR复位) 
2. 从待机模式中返回

### 3.后备域复位

备份区域拥有两个专门的复位，它们只影响备份区域 。

1. 软件复位，备份区域复位可由设置备份域控制寄存器(RCC_BDCR)(见7.3.9节)中的 BDRST位产生。
2. 在VDD和VBAT两者掉电的前提下，VDD或VBAT上电将引发备份区域复位。

## 二、时钟

1. 三种不同的时钟源可被用来驱动系统时钟(SYSCLK)：
   1. HSI振荡器时钟（高速内部时钟）
      1. 高速外部时钟信号(HSE)由以下两种时钟源产生：
         1. HSE外部晶体/陶瓷谐振器 
         2. HSE用户外部时钟
      2. 为了减少时钟输出的失真和缩短启动稳定时间，晶体/陶瓷谐振器和负载电容器必须尽可能地靠 近振荡器引脚。负载电容值必须根据所选择的振荡器来调整。
      3. 在这个模式里，*必须提供外部时钟*。它的频率最高可达*50MHz*。用户可通过设置在时钟控制寄存器中的HSEBYP和HSEON位来选择这一模式。外部时钟信号(50%占空比的方波、正弦波或 三角波)必须连到SOC_IN引脚，同时保证OSC_OUT引脚悬空。
      4. 3~25Mz外部振荡器可为系统提供非常精确的主时钟。
      5. HSE晶体可以通过设置时钟控制寄存器(RCC_CR)中的HSEON位被启动和关闭。
   2. HSE振荡器时钟（高速外部时钟）
      1. HSI时钟信号由内部8MHz的RC振荡器产生，可直接作为系统时钟或在2分频后作为PLL输入。 HSI RC振荡器能够在不需要任何外部器件的条件下提供系统时钟。它的启动时间比HSE晶体振 荡器短。然而，即使在校准之后它的时钟频率精度仍较差。
      2. 如果HSE晶体振荡器失效，HSI时钟会被作为备用时钟源。
   3. PLL时钟（锁相环倍频时钟）
      1. 主PLL以下述时钟源之一为输入，产生倍频的输出： 
         1. HSI时钟除以2
         2. HSE或通过一个可配置分频器的PLL2时钟

2. 二级时钟源：

   1. 40kHz低速内部RC(LSI RC)振荡器
   2. 32.768kHz低速外部晶体(LSE晶体)

3. 注意：产品时钟越高，功率越大

4. `CubeMX`时钟树的讲解

   1. RCC选择外部时钟HSE

   ![1](img\1.png)

   2. 三种时钟输入部分的介绍

   ![2](img\2.png)

   3. 时钟的工作限定

   ![4](img\4.png)

   4. HCLK设置

   ![3](img\3.png)

   5. APBx的时钟配置说明

   ![5](img\5.png)

   6. 补，将系统时钟通过引脚输出出来，勾选后会自动配置引脚

   ![6](img\6.png)

   

## 三、中断

### 1.什么是中断：

1. 中断是指计算机运行过程中，出现某些意外情况需主机干预时，机器能自动停止正在运行的程序并转入处理新情况的程序，处理完毕后又返回原被暂停的程序继续运行。

2. 中断的优先级分别两种：可编程、不可编程。
3. 对于STM32的中断优先级，决定着内核优先相应谁的中断请求。
4. 小值优先原则，中断优先级数值越小，中断会被优先响应。
5. 中断优先级按照优先级分组配置。

### 2.优先级分组

![7](img\7.png)

1. 通过优先级分组，可以管理中断的响应顺序。

2. 只有抢占优先级才有抢占中断权限，发生中断嵌套。

例：B中断正在执行，A中断抢占优先级数值比B中断小（A抢占优先级比B高），A中断则抢过B中断的使用权，响应A的中断服务函数，A中断执行完再交回B。

3. 如果中断抢占优先级相同，不发生抢占行为。

4. 如果多个挂起的中断具有相同的抢占优先级，则子优先级高的先行，如果子优先级相同，则IRQ编号小的先行。

5. 可编程的优先级，通过嵌套向量中断控制器(NVIC)实现。

### 3.Cubemx配置

1. 配置GPIO引脚

![8](img\8.png)

![9](img\9.png)

2. 配置终端优先级

![10](img\10.png)

代码：

```c
void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  /*Configure GPIO pin : PC13 */
  GPIO_InitStruct.Pin = GPIO_PIN_13;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING_FALLING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);
  /* EXTI interrupt init*/
  HAL_NVIC_SetPriority(EXTI15_10_IRQn, 4, 0);
  HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);
}
```


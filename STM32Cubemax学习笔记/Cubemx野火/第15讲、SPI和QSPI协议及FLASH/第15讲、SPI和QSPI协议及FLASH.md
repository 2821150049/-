# 第15讲、SPI和QSPI协议及Flash

## 一、SPI简介

```
SPI协议是由摩托罗拉公司提出的通讯协议(Serial Peripheral Interface)，即串行外围设备接口，是一种高速全双工的通信总线。它被广泛地使用在ADC、LCD等设备与MCU间，要求通讯速率较高的场合。
```

<img src="img\12.png" alt="12" style="zoom:60%;" />

### 1.SPI特点

1. SS/CS
   1. *从设备选择信号线*，*常称为片选信号线*，也称为NSS、CS。
   2. 每个从设备都有独立的这一条SS信号线，本信号线独占主机的一个引脚，即有多少个从设备，就有多少条片选信号线。I2C协议中通过设备地址来寻址、选中总线上的某个设备并与其进行通讯；
   3. 而SPI协议中没有设备地址，它使用SS信号线来寻址，当*主机要选择从设备*时，把该从设备的*SS*信号线*设置为低电平*，该从设备即被选中，即片选有效，接着主机开始与被选中的从设备进行SPI通讯。所以SPI通讯以SS线置低电平为开始信号，以SS线被拉高作为结束信号。
2. SCK (Serial Clock)
   1. 时钟信号线，用于*通讯数据同步*。
   2. 它由通讯主机产生，并决定了通讯的速率，不同的设备支持的最高时钟频率不一样，两个设备之间通讯时，通讯速率受限于低速设备。
3. MOSI (Master Output， Slave Input)：**写指令**
   1. *主设备输出/从设备输入引脚*。
   2. 主机的数据从这条信号线输出，从机由这条信号线读入主机发送的数据，即这条线上数据的方向为主机到从机。
4. MISO(Master Input,，Slave Output)：**读数据**
   1. *主设备输入/从设备输出引脚。*
   2. 主机从这条信号线读入数据，从机的数据由这条信号线输出到主机，即在这条线上数据的方向为从机到主机。

### 2.协议层

![](img\2.png)

1. 起始信号、停止信号
   1. 标号1处，NSS信号线由高变低，是SPI通讯的起始信号。NSS是每个从机各自独占的信号线，当从机检在自己的NSS线检测到起始信号后，就知道自己被主机选中了，开始准备与主机通讯。
   2. 在图中的标号6处，NSS信号由低变高，是SPI通讯的停止信号，表示本次通讯结束，从机的选中状态被取消。

2. 数据有效性

   1. SPI使用MOSI及MISO信号线来传输数据，使用SCK信号线进行数据同步。MOSI及MISO数据线在SCK的每个时钟周期传输一位数据，且数据**输入输出是同时进行**的。

3. CPOL/CPHA及通讯模式

   1. **时钟极性CPOL**是指SPI通讯设备处于空闲状态时，SCK信号线的电平信号(即SPI通讯开始前、 NSS线为高电平时SCK的状态)。*CPOL=0*时， SCK在空闲状态时为*低电平*，CPOL=1时，则相反。`决定上升沿被采样还是下降沿被采样`
   2. **时钟相位CPHA**是指数据的采样的时刻，当*CPHA=0*时，MOSI或MISO数据线上的信号将会在SCK时钟线的“*奇数边沿*”被采样。当*CPHA=1*时，数据线在SCK的“*偶数边沿*”采样。`决定奇数边沿被采样还是偶数边沿被采样`
   3. 由CPOL及CPHA的不同状态，SPI分成了四种模式，主机与从机需要工作在相同的模式下才可以正常通讯，实际中采用较多的是“模式0”与“模式3”。

   ![3](img\3.png)

   ![4](img\4.png)

## 二、QSPI通信协议

### 1.简介

1. QSPI 是Queued SPI的简写，是 Motorola 公司推出的 SPI 接口的扩展，比 SPI 应用更加广泛。 在 SPI 协议的基础上， Motorola 公司对其功能进行了增强，增加了队列传输机制，推出了队列串行外围接口协议（即 QSPI 协议）。 QSPI 是一种专用的通信接口，连接单、双或四（条数据线） SPI Flash存储介质。STM32上将种接口称为QUADSPI接口。
2. 硬件连接图

![5](img\5.png)

### 2.协议

![6](img\6.png)

## 三、SPI串行闪存flash

*封装：*

<img src="img\8.png" alt="8" style="zoom:67%;" />

*接线图：*

![](img\7.png)



### 1.W25Q64

1. 一般说明
   1. W25Q64由每页256个字节组成，每页的256个字节用一次页编程指令就可以完成，每次可以擦除16页（1个扇区）、128页（32KB块）、256页（64KB块）和全片擦除。
   2. 空间结构：1页=256个字节，16页=1个扇区，16个扇区=1块，容量为8M字节，共有128个块，2048个扇区。
2. 协议标准
   1. **支持SPI工作模式0和3**
   2. **数据传输从高位开始，数据传输格式为8位**


# 				定时器

### 一、定时器概述

1. 基本概念

> 定时器是对周期固定的脉冲信号进行计数。
>
> 计数器是对周期不固定的脉冲信号进行计数。
>
> 定时器和计数器本质上都是计数器，定时器是计数器的一种特例。

2. 定时器使用关注的3个问题

> + 位宽：定时器的计数范围，16位定时器的最大值为65535
> + 计数器：定时器的初值的设置、定时器的终值的设置
> + 处理：定时器溢出以后需要完成的操作。

3. 定时器模式的两个概念。

> + 时钟频率：定时模式下，送入定时器的周期性时钟信号的频率。
> + 计数周期：在定时器模式下，技术单元计一次数所花费的时间，他是时钟频率的倒数。
>
> 定时时间计算公式：
>
> 1. 定时时间 = 计算值 * 计数周期
> 2. 计时时间 = 计数值 / 时钟频率

### 二、32定时器家族

![1](img\1.png)

1. 常规定时器

   + 基本定时器

     几乎没有任何输入/输出通道，常用作时基，实现基本的定时/计数功能。

   + 通用定时器

     具备多路独立的捕获和比较通道，可以完成定时/计数、输入捕获 

   + 高级定时器：

     除具备通用定时器的功能外，还具备带死区控制的互补信号输出，紧急刹车关断输入等功能，可用于电机控制和数字电源设计。

2. 定时器的时钟频率由所挂接的外设总线时钟APB决定。

3. 主要功能

   ![2](img\2.png)

### 三、外设模块设计方法

1. 简单外设

> GPIO外设使用引脚初始化数据类型，GPIO_InitTypedef来描述GPIO引脚的属性：引脚编号、工作模式、输出速度等。

2. 复杂外设

> 定时器外设有三类功能：
>
> + 定时/计数功能
> + 输出比较功能
> + 输入捕获功能

3. 复杂外设，三种基本设计方法

   ![3](img\3.png)

   3.1. 外设句柄

   ![4](img\4.png)

![5](img\5.png)

​	  3.2. 外设编程模型

![6](img\6.png)

​	  3.3. 通用接口函数和扩展接口函数

![7](img\7.png)

![8](img\8.png)

### 四、定时器的定时/计数功能

1. 时基单元

![9](img\9.png)

+ 时基单元功能框架

![10](img\10.png)

+ 预分配模块

  ![11](img\11.png)

> 工作原理：定时器启动后，预分配计数器的初值为0.预分配时钟CK_PSC每来一个时钟，预分配计数器的值就加1.当计数值等于预分配寄存器所设定的预分配系数PSC时，预分配计数器的值将清零，开始下一轮计数。

+ + + 预分配时序图

![12](img\12.png)

+ + 计数模块

![14](img\14.png)

+ + 自动重装载模块

![13](img\13.png)

+ 计数模式(三种)

> 中心对齐计数，递增计数，递减计数

+ 定时时间公式

![15](img\15.png)

+ 相关寄存器

![16](img\16.png)

### 五、外部脉冲计数

![17](img\17.png)

![18](img\18.png)

### 六、定时/计数功能的数据类型和接口函数

1. 时基单元初始化类型

![19](img\19.png)

+ ClockDivision

![28](img\28.png)

+ CounterMode

![26](img\26.png)

+ AutoReloadPreload

![27](img\27.png)

2. 接口函数

> + 时基单元初始化函数（HAL_TIM_Base_Init()）

![21](img\21.png)

> + 轮询模式启动函数（HAL_TIM_Base_Start()）

![22](img\22.png)

> + 中断模式启动函数（HAL_TIM_Base_Start_IT()）

![23](img\23.png)

> + 定时器中断通用处理函数（HAL_TIM_IRQHandler()）

![24](img\24.png)

> + 定时器更新中断回调函数(HAL_TIM_PeriodElapsedCallback())

![25](img\25.png)

> + 计数值读取函数(__HAL_TIM_GET_COUNTER())

```C
#define __HAL_TIM_GET_COUNTER(__HANDLE__) ((__HANDLE__)->Instance->CNT)
```

> + 定时器中断标志清楚函数（__HAL_TIM_CLEAR_IT()）

```C
#define __HAL_TIM_CLEAR_IT(__HANDLE__,__INTERRUPT__) ((__HANDLE__)->Instance->SR = ~(__INTERRUPT__))
```

![20](img\20.png)
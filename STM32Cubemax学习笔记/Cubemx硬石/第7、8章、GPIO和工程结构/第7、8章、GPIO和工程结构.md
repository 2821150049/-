# 第7、8章、GPIO和工程结构

[toc]

## 一、GPIO介绍

### 1. 简单描述

1. GPIO最简单的功能是输出高低电平
2. GPIO还可以被设置为输入功能，用于读取外部输入信号，比如按键、开关等信号。
3. 很多高级外设也有功能引脚，并且是与GPIO共用的，具体引脚功能可以通过软件编程设置对应的寄存器内容实现的。

### 2. 电路结构

<img src="img\2.png" alt="2" style="zoom:80%;" />

### 3. GPIO控制寄存器介绍

每个GPIO包括10个寄存器来配置GPIO的具体功能（**每个引脚功能都是完全可以独立配置，互不影响**）：

```c
GPIOx_MODER ：     	模式寄存器
GPIOx_OTYPER ：    	输出类型寄存器
GPIOx_OSPEEDR ： 	输出速度寄存器
GPIOx_PUPDR ：     	上拉/下拉寄存器
GPIOx_IDR ：       	输入数据
GPIOx_ODR ：         输出数据寄存器
GPIOx_BSRR ：        置位/复位寄存器
GPIOx_LCKR ：        配置锁定寄存器
GPIOx_AFRL ：        复用功能低位寄存器
GPIOx_AFRH ：       	复用功能高位寄存器
// x表示在那个组 R表示寄存器、
// 每个型号的单片机的寄存器个数不一定相同（就是说F1和F4架构发生改变）
```

### 4. 通用输入输出模式

<img src="img\1.png" alt="1" style="zoom:67%;" />

#### 4.1. 输入模式

1. 浮空输入模式
   1. 当GPIOx_MODER模式寄存器位[1:0]设置为00
   2. 上/下拉寄存器PUPDR[1:0]位设置为00时
   3. STM32复位之后默认模式
2. 输入上拉模式
   1. 在浮空输入模式基础上使能输入电路中的上拉开关
   2. 上拉开关由上/下拉寄存器PUPDR[0:1]设置为01来使能
3. 输入下拉模式(一般情况不上拉也不下拉，不管什么模式)
   1. 在浮空输入模式基础上使能输入电路中的下拉开关
   2. 下拉开关由上/下拉寄存器PUPDR[0:1]设置为10来使能。
4. 电路讲解

> I/O引脚信号接入到施密特触发器的输入端，*在每来一个AHB1(168MHz)时钟脉冲就把输入端的信号传输到触发器的输出端***（其实可以理解为采样频率）**，施密特触发器的输出端又是与输入数据寄存器(GPIOx_IDR)连通的，所以该数据就保存在输入数据寄存器内，寄存器本身就是一个存储单元(起到缓冲区效果)，所以输入数据寄存器保存着I/O引脚电平。另外，CPU随时都可以读取寄存器数据，从而得知当前引脚状态。

<img src="img\6.png" alt="6" style="zoom:50%;" />

*模式寄存器：*用于选择模式

<img src="img\3.png" alt="3" style="zoom:60%;" />

*输出类型寄存器：*

<img src="img\4.png" style="zoom:67%;" />

*端口上下拉寄存器：*

<img src="img\5.png" style="zoom:60%;" />

*输入数据寄存器：*

<img src="img\7.png" style="zoom:60%;" />

5. 模拟模式
   1. 当STM32需要进行ADC或DAC转换时，需要把引脚设置为模拟输入模式
   2. 该模式需要配合ADC或DAC外设使用，否则没有意义。

<img src="img\8.png" style="zoom:60%;" />

#### 4.2. 输出模式

**通用输出模式就是做为普通用途的输出模式，比如简单地控制引脚输出高低电平。GPIO的输出是由一个PMOS管和一个NMOS管组合形成的反相器驱动。**

1. 开漏输出模式

   1. 开漏电路概念中的“漏”是指MOS管的漏极(D)，实际只是利用到NMOS管，PMOS管在开漏模式下是没有用到的
   2. 设置输出高电平时引脚实际是高组态（实际测量的是施密特触发器的值）
   3. 另外，整个过程**施密特触发输入是被被激活的**，出现在**I/O**脚上的数据在每个**AHB1**时钟被采样到输入数据寄存器，对输入数据寄存器的读访问可得到**I/O**状态。
   4. 电路：

   <img src="img\9.png" alt="9" style="zoom:50%;" />

2. 推挽通用输出模式

   1. 推挽输出把PMOS管和NMOS管都用上
   2. 设置输出高电平时引脚实际是有电流从引脚流出
   3. 电路:

   <img src="img\12.png" style="zoom:60%;" />

3. 复用功能输出模式

   1. 一个I/O引脚可以做为普通的IO接口，还可以做为其他外设的特殊功能引脚，有些引脚可能有4、5种不同功能，这种现象就叫做复用。引脚复用为特殊功能引脚，那引脚状态就由该外设决定。
   2. 电路：

   <img src="img\13.png" style="zoom:60%;" />

*置位复位寄存器：*

<img src="img\10.png" style="zoom:60%;" />

*输出数据寄存：*

<img src="img\11.png" alt="11" style="zoom:60%;" />

*复用功能寄存器：*

<img src="img\14.png" style="zoom:60%;" />

<img src="img\15.png" style="zoom:60%;" />



*模口配置：*

<img src="img\16.png" alt="16" style="zoom:67%;" />

*锁定寄存器：*

<img src="img\17.png" style="zoom:60%;" />

<img src="img\18.png" style="zoom:60%;" />



## 二、工程结构

不用管


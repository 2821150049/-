# 第17章、高级定时器

## 一、高级定时器概述

1. 高级定时器包含有通用定时器的所有功能。高级定时器位于APB2总线上，最高时钟可达168 MHz。

2. 包含16位的自动重装载计数器和预分频器。
3. 计数模式
   1. 向上
   2. 向下
   3. 中心对齐
4. 4个16位高精度捕捉比较通道
   1. 输入捕获、PWM输入捕获
   2. 输出比较，PWM输出，单脉冲模式
5. 使用外部信号控制定时器
   1. 定时器主/从设备同步
   2. 外部触发同步
   3. 触发或门控制
6. 重复计数器
7. 死区之间
8. 刹车输入信号
9. 增量式编码器和霍尔传感器
10. 独立的IRQ/DMA请求生成器
    1. 更新事件
    2. 触发事件
    3. 输入捕获
    4. 输出比较
    5. 刹车信号输入

## 二、时钟源、控制器及时基单元

![1](img\1.png)

### 1.时钟源

时钟源包含四种，如下图。

<img src="img\2.png" alt="2" style="zoom:50%;" />

1. **内部时钟CK_INT**

内部时钟CK_INT即来自于STM32芯片内部APB总线，对于TIM1和TIM8等于168 MHz（其他TIM在上章视频已经做了详细介绍），我们在一般情况下都是使用内部时钟。

2. **外部时钟模式2 TINx**

   ![](img\3.png)

   1. 时钟信号输入引脚

   ```
   使用外部时钟模式1时，有2个来自于定时器输入通道的时钟信号，分别是TI1FP1和TI2FP2， TI1FP1对应IC1（TIMx_CH1），TI2FP2对应IC2（TIMx_CH2），配置TIMx_CCMR1的位CCxS[1：0]来选择哪一路信号。注意，TI3和TI4是不能做外部时钟模式1的引脚。
   ```

   2. 滤波器

   ```
   作用很简单，是为了滤除输入信号上的高频干扰。这里可以通过寄存器配置不同的滤波时间。
   ```

   `TIN1F`主要配置`IC1F`来选择滤波器频率

   ![4](img\4.png)

   

   3. 边缘检测

   ```
   来自于滤波后的信号，此时是为了检测上升沿有效还是下降沿有效，具体的由TIMx_CCER的位CCxP和CCxNP配置。
   ```

   ![5](img\5.png)

   4. 触发选择

   ```
   若选择外部时钟模式1，此时由两个触发源，一个是滤波后的定时器输入1（TI1FP1）和滤波后的定时器输入2（TI2FP2），具体的由TIMx_SMCR的位TS[2:0]配置。
   ```

   5. 从模式选择

   ```
   选定了触发源信号后，信号是接到TRGI引脚的，让触发信号成为外部时钟模式1的输入（TIMx_SMCR寄存器的SMS=111），即为CK_PSC。
   ```

3. **外部时钟模式2 ETR**

   ![6](img\6.png)

   1. 时钟信号输入引脚ETR

   ```
   使用外部时钟模式2时，时钟信号来自于定时器特定输入通道TIM_ETR。
   ```

   2. 外部触发极性

   ```
   TIMx_SMCR寄存器中的ETP位控制触发极性。0：ETR未反相，高电平或上升沿有效。1：ETR反相，低电平或下降沿有效。
   ```

   3. 分频器

   ```
   当触发信号的频率很高时，就必须使用分频器进行降频，有1/2/4/8,可选择，是由TIMx_SMCR寄存器中的ETPS[1：0]配置。使得输出信号ETRP频率必须小于TIMxCLK频率的1/4。
   ```

   4. 滤波器

   ```
   如果ETRP的信号的频率过高或者混杂有高频干扰信号的话，我们就需要使用滤波器对ETRP信号重新采样，达到降频或者去除干扰的目的。由TIMx_SMCR的位ETF[3：0]配置，其中fDTS是由内部时钟CK_INT分频得到，由TIMx_CR1的位CKD[1：0]配置。
   ```

   ![7](img\7.png)

   5. 从模式选择

   ```
   经滤波后的信号连接至ETRF引脚，CK_PSC输出，驱动计数器。由TIMx_SMCR的位ECE置1即可配置为外部时钟模式2。
   ```

4. **内部触发输入 ITRx**

   1. TIMx定时器从内部连接在一起，以实现定时器同步或级联。当某个定时器配置为主模式时，可对另一个配置为从模式的定时器的计数器执行复位、启动、停止操作或为其提供时钟。

   ![8](img\8.png)

### 2.控制器

<img src="img\9.png" alt="9" style="zoom:67%;" />

1. 功能

```
触发控制器用来针对片内外设输出触发信号，为其它定时器提供时钟和触发DAC/ADC转换。
编码器接口专门针对编码器计数而设计。
从模式控制器可以控制计数器复位、启动、递增/递减、计数。
```

### 3.时基单元

![10](img\10.png)

```
高级控制定时器的主要模块是一个16位计数器及其相关的自动重载寄存器。计数器可递增计数、递减计数或交替进行递增和递减计数。计数器的时钟可通过预分频器进行分频。
计数器、自动重载寄存器和预分频器寄存器可通过软件进行读写。即使在计数器运行时也可执行读写操作。
```

1. 包含

   1. 计数器寄存器(`TIMx_CNT`)

      ```
      	向上计数模式：计数器开始从0计数到自动重装载值（TIMx_ARR计数器内容），然后重新从0开始并且产生一个计数器溢出事件。如果使用重复计数器，则当递增计数的重复次数达到重复计数器寄存器中编程的次数加一次(TIMx_RCR+1)后，将生成更新事件(UEV)，由此可见，不是每次发生溢出事件就会产生更新事件的。否则(不使用重复计算器即TIMx_RCR=0)，将在每次计数器上溢时产生更新事件。
      	将TIMx_EGR寄存器的UG（更新事件生成）位置1（通过软件或使用从模式控制器）时，也将产生更新事件。
      	通过软件将TIMx_CR1寄存器中的UDIS位置1可禁止UEV（更新）事件。这可避免向预装载寄存器写入新值时更新影子寄存器。在UDIS位写入0之前不会产生任何更新事件。不过，计数器和预分频器计数器都会重新从0开始计数（而预分频比保持不变）。
      	此外，如果TIMx_CR1寄存器中的URS位（更新请求选择）已置1，则将UG位置1会生成更新事件UEV，但不会将UIF标志置1（因此，不会发送任何中断或 DMA 请求）。这样一来，如果在发生捕获事件时将计数器清零，将不会同时产生更新中断和捕获中断。
      	发生更新事件时，将更新所有寄存器且将更新标志（TIMx_SR寄存器中的UIF位）置 1（取决于 URS 位）：
      	重复计数器中将重新装载TIMx_RCR寄存器的内容
      	自动重载影子寄存器将以预装载值(TIMx_ARR)进行更新
      	预分频器的缓冲区中将重新装载预装载值（TIMx_PSC寄存器的内容）
      ```

   2. 预分频器寄存器(`TIMx_PSC`)

      ```
      预分频器PSC有一个输入时钟CK_PSC和一个输出时钟CK_CNT。输入时钟来源于控制器部分(实际CK_PSC就是我们在①时钟源的输出结果)，通过设置预分频的数值，可以得到不同的CK_CNT，它实际计算的式子为：
      CK_CNT=FCK_PSC/(PSC[15：0]+1)
      因为TIMx_PSC控制寄存器具有缓冲（影子寄存器），可以在运行过程中改变它的数值，新的预分频数值将在下一个更新事件时起作用。
      ```

   3. 自动装载寄存器(`TIMx_ARR`)

      ```
      这个寄存器是预先装载的，当写或读自动重装载寄存器将访问预装载寄存。控制TIMx_CR1寄存器中的自动重装载预装载使能位（ARPE），如果置1，预装载寄存器的内容在每次更新事件时传递给影子寄存器；如果置0，修改TIMx_ARR的值后马上有效。
      ```

   4. 重复次数寄存器(`TIMx_RCR`)

      ```
      	实际上，只有当重复计数器达到0时，才会生成更新事件。这在生成PWM信号时很有用。这意味着，每当发生N+1个计数器上溢或下溢（其中，N是TIMx_RCR重复计数器寄存器中的值），数据就将从预装载寄存器转移到影子寄存器（TIMx_ARR自动重载寄存器、TIMx_PSC 预分频器寄存器以及比较模式下的TIMx_CCRx捕获/比较寄存器）。
      重复计数器在下列情况下递减：
      ● 递增计数模式下的每个计数器上溢。
      ● 递减计数模式下的每个计数器下溢。
      ● 中心对齐模式下每个计数器上溢和计数器下溢。尽管这使得最大重复次数不超过 128个PWM周期，但在每个PWM周期内可更新占空比两次。当在中心对齐模式下，每个PWM 周期仅刷新一次比较寄存器时，由于模式的对称性，最大分辨率为 2xTck。
      	重复计数器是自动重载类型；其重复率为 TIMx_RCR 寄存器所定义的值。
      	当更新事件由软件（通过将TIMx_EGR寄存器的UG位置1）或硬件（通过从模式控制器）生成时，无论重复计数器的值为多少，更新事件都将立即发生，并且在重复计数器中重新装载TIMx_RCR寄存器的内容。
      ```

      

## 三、复用功能

### 1.输入捕获







### 2.输出比较





### 3.脉冲宽度调节PWM





### 4.单脉冲模式





### 5.编码器接口、霍尔传感器接口